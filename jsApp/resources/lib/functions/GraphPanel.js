metExploreD3.GraphPanel={getHeight:function(a){return d3.select("#"+a).select("#D3viz").style("height")},getWidth:function(a){return d3.select("#"+a).select("#D3viz").style("width")},resizeViz:function(b){var f=metExploreD3.getScaleById(b);if(f!=undefined){d3.select("#metexplore").text("");d3.select("#"+b).select("#D3viz").attr("width",$("#"+b).width());d3.select("#"+b).select("#D3viz").attr("height",$("#"+b).height());var g=d3.select("#viz").select("#D3viz").select("#captionPathway").attr("y");d3.select("#"+b).select("#D3viz").selectAll(".foreignObjectCaptionContainer").selectAll(".captionContainer").style("height",($("#"+b).height()-g-15)+"px");var a=f.getZoomScale();var e=d3.scale.linear().domain([0,$("#"+b).width()]).range([0,$("#"+b).width()]);var d=d3.scale.linear().domain([$("#"+b).height(),0]).range([$("#"+b).height(),0]);var c=f.getZoom().translate();f.getZoom().x(e).y(d).translate(c).scale(a);d3.select("#"+b).select("#D3viz").select("#brush").call(d3.svg.brush().x(e).y(d).on("brushstart",function(k){document.addEventListener("mousedown",function(m){if(m.button===1){m.stopPropagation();m.preventDefault();m.stopImmediatePropagation()}});var i=d3.select("#"+b).select("#buttonHand").attr("scrollable");_MyThisGraphNode.activePanel=this.parentNode.parentNode.id;var j=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(d3.event.sourceEvent.button!=1&&i!="true"){if(j!=undefined){if(j.isLinked()){var l=_metExploreViz.getSessionById("viz");if(l!=undefined){var h=l.getForce();if(h!=undefined){h.stop()}}}else{var h=j.getForce();if(h!=undefined){h.stop()}}}brushing=true;d3.select("#"+b).select("#brush").classed("hide",false);d3.select("#"+b).select("#D3viz").on("mousedown.zoom",null);nodeBrushed=d3.select("#"+b).select("#graphComponent").selectAll("g.node");nodeBrushed.each(function(m){m.previouslySelected=m.isSelected()})}else{var h=j.getForce();if(h!=undefined){h.stop()}d3.select("#"+b).selectAll("#D3viz").style("cursor","all-scroll");d3.selectAll("#brush").classed("hide",true)}}).on("brushend",function(){if(d3.event.sourceEvent.button!=1&&brushing){var p=d3.event.target.extent();if(p[1][0]-p[0][0]>20||p[1][1]-p[0][1]>20){var m;var p=d3.event.target.extent();var j=metExploreD3.getScaleById(b);var l=j.getZoomScale();var i=metExploreD3.createLoadMask("Selection in progress...",b);if(i!=undefined){metExploreD3.showMask(i);metExploreD3.deferFunction(function(){nodeBrushed.classed("selected",function(w){var v=j.getZoom().x();var u=j.getZoom().y();m=(v(p[0][0])<=v(w.x)&&v(w.x)<v(p[1][0]))&&(u(p[0][1])<=u(w.y)&&u(w.y)<u(p[1][1]));if((w.isSelected()==false&&m==true)||(w.isSelected()==true&&m==false&&!w.previouslySelected)){_MyThisGraphNode.selection(w,b)}return m});metExploreD3.hideMask(i);var s=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(s!=undefined){if(s.isLinked()){var t=_metExploreViz.getSessionById("viz");if(t!=undefined){var q=metExploreD3.GraphNetwork.isAnimated(t.getId());if(q=="true"){var r=t.getForce();if(r!=undefined){if((metExploreD3.GraphNetwork.isAnimated(t.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(t.getId())==null)){r.start()}}}}}else{var r=s.getForce();var q=metExploreD3.GraphNetwork.isAnimated(s.getId());if(q=="true"){var r=s.getForce();if(r!=undefined){if((metExploreD3.GraphNetwork.isAnimated(s.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(s.getId())==null)){r.start()}}}}}brushing=false},100)}}}else{var n=_metExploreViz.getSessionById(_MyThisGraphNode.activePanel);if(n!=undefined){if(n.isLinked()){var k=_metExploreViz.getSessionById("viz");if(k!=undefined){var o=metExploreD3.GraphNetwork.isAnimated(k.getId());if(o=="true"){var h=k.getForce();if(h!=undefined){if((metExploreD3.GraphNetwork.isAnimated(k.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(k.getId())==null)){h.start()}}}}}else{var h=n.getForce();var o=metExploreD3.GraphNetwork.isAnimated(n.getId());if(o=="true"){var h=n.getForce();if(h!=undefined){if(d3.select(metExploreD3.GraphNetwork.isAnimated(n.getId())=="true")||(metExploreD3.GraphNetwork.isAnimated(n.getId())==null)){h.start()}}}}}}d3.event.target.clear();d3.select(this).call(d3.event.target);var j=metExploreD3.getScaleById(b);d3.select("#"+b).selectAll("#D3viz").style("cursor","default");d3.select("#"+b).selectAll("#D3viz").call(j.getZoom()).on("dblclick.zoom",null).on("mousedown",null);d3.event.target.extent();d3.selectAll("#brush").classed("hide",false)}));d3.select("#viz").select("#D3viz").select("#logoViz").select("image").attr("x",$("#viz").width()-88).attr("y",$("#viz").height()-70);d3.select("#metexplore").text("MetExploreViz").attr("x",$("#viz").width()-112).attr("y",$("#viz").height()-10)}},resizePanels:function(a){var g=_metExploreViz.getSessionsSet();var i=_metExploreViz.getSessionById(a);var e=$("#"+a).height();var l=$("#"+a).width();var j=d3.select("#viz").select("#D3viz").select("#captionPathway").attr("y");d3.select("#"+a).select("#D3viz").selectAll(".foreignObjectCaptionContainer").selectAll(".captionContainer").style("height",(e-j-15)+"px");if(d3.select("#"+a).select("#D3viz").select("#buttonZoomIn")[0][0]!=null&&d3.select("#"+a).select("#D3viz").select("#buttonZoomOut")[0][0]!=null&&d3.select("#"+a).select("#D3viz").select("#buttonHand")[0][0]!=null){var k=d3.select("#"+a).select("#D3viz").select("#buttonZoomIn").attr("x");var d=l-60-k;d3.select("#"+a).select("#D3viz").select("#buttonZoomIn").attr("transform","translate("+d+",0) scale(1)");k=d3.select("#"+a).select("#D3viz").select("#buttonZoomOut").attr("x");d=l-110-k;d3.select("#"+a).select("#D3viz").select("#buttonZoomOut").attr("transform","translate("+d+",0) scale(1)");k=d3.select("#"+a).select("#D3viz").select("#buttonHand").attr("x");d=l-160-k;d3.select("#"+a).select("#D3viz").select("#buttonHand").attr("transform","translate("+d+",0) scale(1)");k=d3.select("#"+a).select("#D3viz").select("#whiteBlack").attr("x");d=l-100-k;d3.select("#"+a).select("#D3viz").select("#whiteBlack").attr("transform","translate("+d+",0) scale(1)");k=d3.select("#"+a).select("#D3viz").select("#invertColor").attr("x");d=l-100-k;d3.select("#"+a).select("#D3viz").select("#invertColor").attr("transform","translate("+d+",0) scale(1)")}if(i!=undefined){if(i.isLinked()){var f=_metExploreViz.getSessionById("viz");var b=f.getForce();if(b!=undefined){var e=$("#viz").height();var l=$("#viz").width();b.size([l,e]);var c=d3.select("#viz").select("#buttonAnim").attr("animation");if(c=="true"){b.resume()}}}else{var b=i.getForce();if(b!=undefined){var e=$("#"+a).height();var l=$("#"+a).width();b.size([l,e]);var c=d3.select("#"+a).select("#buttonAnim").attr("animation");if(c=="true"){b.resume()}}}}var n=_metExploreViz.getSessionsSet();var i=_metExploreViz.getSessionById(a);if(i!=undefined){var c=metExploreD3.GraphNetwork.isAnimated(a);if(c=="true"){if(i.isLinked()){for(var m in n){if(n[m].isLinked()){metExploreD3.GraphNetwork.animationButtonOn(n[m].getId())}}var b=_metExploreViz.getSessionById("viz").getForce();b.resume()}else{metExploreD3.GraphNetwork.animationButtonOn(a);var b=i.getForce();b.resume()}}}},removeSvgComponents:function(a){d3.select("#"+a).select("#D3viz").selectAll("*").remove()},refreshJSON:function(c){var b=metExploreD3.GraphUtils.decodeJSON(c);if(b){if(!_metExploreViz.isLaunched()||metExploreD3.isNewBioSource()){metExploreD3.GraphPanel.initiateViz("D3")}var d=Ext.getCmp("viz");if(d!=undefined){var a=metExploreD3.createLoadMask("Refresh in process...","viz");if(a!=undefined){metExploreD3.showMask(a);var e=this;setTimeout(function(){metExploreD3.fireEvent("selectConditionForm","resetMapping");if(b.sessions!=undefined){metExploreD3.GraphPanel.loadDataJSON(c,f)}else{metExploreD3.GraphPanel.initDataJSON(c,f)}function f(){metExploreD3.hideMask(a);metExploreD3.fireEvent("graphPanel","afterrefresh");if(metExploreD3.isNewBioSource()){metExploreD3.hideInitialMask();metExploreD3.setIsNewBioSource(false);_metExploreViz.setLaunched(true)}}},100)}}}},refreshPanel:function(b,d){var c=this;metExploreD3.hideInitialMask();var a=metExploreD3.GraphUtils.decodeJSON(b);if(a.nodes||a.sessions){if(metExploreD3.isNewBioSource()||!_metExploreViz.isLaunched()||metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.GraphPanel.refreshJSON(b);if(typeof d==="function"){d()}}else{Ext.Msg.show({title:"Are you sure?",msg:"This action will remove previous network. <br />Would you like to do this?",buttons:Ext.Msg.OKCANCEL,fn:function(e){if(e=="ok"){metExploreD3.GraphPanel.refreshJSON(b);if(d!=undefined&&typeof d==="function"){d()}}},icon:Ext.Msg.QUESTION})}}else{metExploreD3.displayWarning("Syntaxe error",'File have bad syntax. Use a saved file from MetExploreViz or see <a href="http://metexplore.toulouse.inra.fr/metexploreViz/doc/documentation.php#generalfunctioning">MetExploreViz documentation</a>.')}},loadDataJSON:function(c,a){var b=metExploreD3.GraphUtils.decodeJSON(c);if(b){if(metExploreD3.bioSourceControled()){_metExploreViz.setBiosource(b.biosource);metExploreD3.fireEventParentWebSite("loadNetworkBiosource",{biosource:b.biosource,func:d,endFunc:a,json:c})}else{d();a()}function d(){var m=_metExploreViz.getSessionById("viz");var k=m.getForce();if(k!=undefined){k.nodes([]);k.links([]);k.on("start",null);k.on("end",null);k.on("tick",null)}m.reset();if(b.comparedPanels){b.comparedPanels.forEach(function(q){_metExploreViz.addComparedPanel(new ComparedPanel(q.panel,q.visible,q.parent,q.title))})}if(b.mappings){b.mappings.forEach(function(q){var q=new Mapping(q.name,q.conditions,q.targetLabel);_metExploreViz.addMapping(q)})}if(b.generalStyle){var g=metExploreD3.getGeneralStyle();var f=new GeneralStyle(g.getWebsiteName(),b.generalStyle.colorMinMappingContinuous,b.generalStyle.colorMaxMappingContinuous,b.generalStyle.maxReactionThreshold,b.generalStyle.displayLabelsForOpt,b.generalStyle.displayLinksForOpt,b.generalStyle.displayConvexhulls,b.generalStyle.clustered,b.generalStyle.displayCaption,g.hasEventForNodeInfo(),g.loadButtonIsHidden(),g.windowsAlertIsDisable());metExploreD3.setGeneralStyle(f)}var n=b.sessions;for(var o in n){if(o!="viz"){var m=new NetworkVizSession();m.setVizEngine("D3");m.setId(o);m.setLinked(n[o].linked);_metExploreViz.addSession(m);var l=Ext.getCmp("comparePanel");l.show();var i=_metExploreViz.getComparedPanelById(o);var p=[{id:i.getParent(),title:i.getTitle(),html:'<div id="'+i.getParent()+'" height="100%" width="100%"></div>',flex:1,closable:true,collapsible:true,collapseDirection:"left"}];l.add(p);l.expand();metExploreD3.fireEventArg("comparePanel","initiateviz",o)}if(n[o].colorMappings){n[o].colorMappings.forEach(function(q){m.addColorMapping(q.name,q.value)})}var j=n[o].animated;if(!j){j=false}m.setAnimated(j);var h=new NetworkData(o);h.cloneObject(n[o].d3Data);var e=h.getNodes();e.forEach(function(q){if(q.getBiologicalType()=="metabolite"){if(h.getCompartmentByName(q.getCompartment())==null){h.addCompartment(q.getCompartment())}}else{q.getPathways().forEach(function(r){if(h.getPathwayByName(r)==null){h.addPathway(r)}})}if(q.getMappingDatasLength()>0){q.getMappingDatas().forEach(function(r){r.setNode(q);if(_metExploreViz.getMappingByName(r.getMappingName())!=null){var s=_metExploreViz.getMappingByName(r.getMappingName());s.addMap(r)}})}});h.setId(o);if(o=="viz"){_metExploreViz.setInitialData(_metExploreViz.cloneNetworkData(h))}m.setD3Data(h);if(n[o].selectedNodes){n[o].selectedNodes.forEach(function(q){m.addSelectedNode(q)})}if(_metExploreViz.getMappingsLength()>0&&o=="viz"&&!metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.displayMessageYesNo("Mapping","Do you want keep mappings.",function(q){if(q=="yes"){_metExploreViz.getMappingsSet().forEach(function(r){metExploreD3.GraphMapping.reloadMapping(r);metExploreD3.fireEventArg("selectMappingVisu","jsonmapping",r)});metExploreD3.fireEventArg("buttonRefresh","reloadMapping",true)}else{metExploreD3.fireEventArg("buttonMap","reloadMapping",false);metExploreD3.fireEventArg("buttonRefresh","reloadMapping",false);metExploreD3.fireEventArg("selectConditionForm","closeMapping",_metExploreViz.getActiveMapping);_metExploreViz.resetMappings()}})}if(n[o].mapped){m.setMapped(n[o].mapped)}if(n[o].mappingDataType){m.setMappingDataType(n[o].mappingDataType)}if(n[o].activeMapping){m.setActiveMapping(n[o].activeMapping)}}if(b.linkStyle){var f=new LinkStyle(b.linkStyle.size,b.linkStyle.lineWidth,b.linkStyle.markerWidth,b.linkStyle.markerHeight,b.linkStyle.markerInColor,b.linkStyle.markerOutColor,b.linkStyle.markerStrokeColor,b.linkStyle.markerStrokeWidth,b.linkStyle.strokeColor);metExploreD3.setLinkStyle(f)}if(b.metaboliteStyle){var f=new MetaboliteStyle(b.metaboliteStyle.height,b.metaboliteStyle.width,b.metaboliteStyle.rx,b.metaboliteStyle.ry,b.metaboliteStyle.fontSize,b.metaboliteStyle.strokeWidth,b.metaboliteStyle.label,b.metaboliteStyle.strokeColor);metExploreD3.setMetaboliteStyle(f)}if(b.reactionStyle){var f=new ReactionStyle(b.reactionStyle.height,b.reactionStyle.width,b.reactionStyle.rx,b.reactionStyle.ry,b.reactionStyle.label,b.reactionStyle.fontSize,b.reactionStyle.strokeColor,b.reactionStyle.strokeWidth);metExploreD3.setReactionStyle(f)}for(var o in n){metExploreD3.GraphNetwork.refreshSvg(o)}a()}}},initDataJSON:function(j,b){var k=metExploreD3.GraphUtils.decodeJSON(j);if(k){var h=_metExploreViz.getSessionById("viz");var c=h.getD3Data();_metExploreViz.resetOldCoodinates();c.getNodes().forEach(function(i){_metExploreViz.addOldCoodinates({id:i.getId(),x:i.x,px:i.px,y:i.y,py:i.py})});var d=h.getForce();if(d!=undefined){d.nodes([]);d.links([]);d.on("start",null);d.on("end",null);d.on("tick",null)}h.reset();h.setAnimated(true);var c=new NetworkData("viz");c.cloneObject(k);var a=c.getNodes();a.forEach(function(i){if(i.getBiologicalType()=="metabolite"){if(c.getCompartmentByName(i.getCompartment())==null){c.addCompartment(i.getCompartment())}}else{i.getPathways().forEach(function(l){if(c.getPathwayByName(l)==null){c.addPathway(l)}})}});c.setId("viz");_metExploreViz.setInitialData(_metExploreViz.cloneNetworkData(c));h.setD3Data(c);metExploreD3.GraphNetwork.refreshSvg("viz");var f=_metExploreViz.getOldCoodinates();if(f.length>0){var g=false;var e=0;while(e<f.length-1&&!g){if(c.getNodeById(f[e].id)!=undefined){g=true}e++}if(g&&!metExploreD3.getGeneralStyle().windowsAlertIsDisable()){metExploreD3.displayMessageYesNo("Coodinates","Do you want keep node coordinates.",function(i){if(i=="yes"){var l=[];f.forEach(function(m){var n=c.getNodeById(m.id);if(n!=undefined){n.x=m.x;n.y=m.y;n.px=m.px;n.py=m.py;l.push(m.id)}});d3.select("#viz").select("#graphComponent").selectAll("g.node").filter(function(m){return l.indexOf(m.id)!=-1}).each(function(m){m.setLocked(!m.isLocked());m.fixed=m.isLocked()});d3.select("#viz").select("#graphComponent").selectAll("g.node").filter(function(m){return l.indexOf(m.id)!=-1}).each(function(m){_MyThisGraphNode.selection(m,"viz")})}})}}if(_metExploreViz.getMappingsLength()>0){_metExploreViz.getMappingsSet().forEach(function(i){metExploreD3.GraphMapping.reloadMapping(i);metExploreD3.fireEventArg("selectMappingVisu","jsonmapping",i)});metExploreD3.fireEventArg("buttonRefresh","reloadMapping",true)}}b()},initiateViz:function(a){d3.select("#viz").selectAll("#presentationViz, #presentationLogoViz").classed("hide",true);metExploreD3.fireEvent("viz","initiateviz");_metExploreViz.setLaunched(true);if(a=="D3"){metExploreD3.GraphNetwork.delayedInitialisation("viz")}},loadData:function(a){var b=_metExploreViz.getSessionById(a);return b}};